<!doctype html>
<meta charset="utf-8">
<title>Policies</title>
<link rel="stylesheet" href="/static/styles.css">

<header>
  <h1 class="title">Policies</h1>
  <span id="health" class="pill">health: …</span>
  <span id="auth" class="pill">auth: off</span>
  <span class="header-actions">
    <input id="apikey" class="key-input" placeholder="X-API-Key (optional)">
    <button id="saveKey">Save key</button>
    <button id="clearKey">Clear</button>
  </span>
</header>

<div id="msg" class="banner"></div>

<form class="inline" onsubmit="event.preventDefault(); add();">
  <input id="number" placeholder="number" required minlength="3">
  <input id="holder" placeholder="holder" required minlength="2">
  <input id="premium" type="number" step="0.01" min="0" placeholder="premium" required>
  <input id="status" placeholder="status" required minlength="2">
  <button>Add</button>
</form>

<form class="inline" method="get">
  <input name="q" value="{{ q }}" placeholder="search">
  <button>Search</button>
</form>

<button id="exportCsv" style="margin-top:.5rem">Export CSV</button>

<table>
  <thead>
    <tr>
      <th data-sort="id">#</th>
      <th data-sort="number">Number</th>
      <th data-sort="holder">Holder</th>
      <th data-sort="premium">Premium</th>
      <th data-sort="status">Status</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for p in items %}
    <tr>
      <td>{{p.id}}</td>
      <td>{{p.number}}</td>
      <td>{{p.holder}}</td>
      <td>{{"%.2f"|format(p.premium)}}</td>
      <td><span class="status {{p.status}}">{{p.status}}</span></td>
      <td><button class="btn-del" data-id="{{p.id}}">Delete</button></td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
const msg = document.getElementById('msg');
function show(type, text){ msg.className='banner '+(type||'error'); msg.textContent=text; }

// Add policy
async function add(){
  const apiKey = localStorage.getItem('API_KEY');
  const body = {
    number: document.getElementById('number').value.trim(),
    holder: document.getElementById('holder').value.trim(),
    premium: parseFloat(document.getElementById('premium').value),
    status: document.getElementById('status').value.trim()
  };
  const res = await fetch('/policies', {
    method:'POST',
    headers: Object.assign({'Content-Type':'application/json'}, apiKey ? {'X-API-Key': apiKey} : {}),
    body: JSON.stringify(body)
  });
  if(res.ok){ location.reload(); return; }
  let detail=''; try{ const j=await res.json(); detail=j.detail||JSON.stringify(j);}catch{}
  if(res.status===401) show('error','Unauthorized: missing/invalid API key.');
  else if(res.status===409) show('error','Duplicate number: that policy already exists.');
  else if(res.status===422) show('error','Validation error: '+detail);
  else show('error','Error '+res.status+': '+detail);
}

// Health + auth UI state
(async function bootstrap(){
  try{
    const h = await fetch('/health').then(r=>r.json());
    document.getElementById('health').textContent = 'health: ' + (h.status || 'unknown');
  }catch{ document.getElementById('health').textContent = 'health: error'; }
  const saved = localStorage.getItem('API_KEY') || '';
  document.getElementById('apikey').value = saved;
  document.getElementById('auth').textContent = 'auth: ' + (saved ? 'key set' : 'off');
})();

document.getElementById('saveKey').onclick = () => {
  const v = document.getElementById('apikey').value.trim();
  if(v){ localStorage.setItem('API_KEY', v); show('ok','API key saved.'); }
  document.getElementById('auth').textContent = 'auth: ' + (v ? 'key set' : 'off');
};
document.getElementById('clearKey').onclick = () => {
  localStorage.removeItem('API_KEY'); document.getElementById('apikey').value=''; 
  document.getElementById('auth').textContent='auth: off'; show('ok','API key cleared.');
};

// Export CSV (respekterar API key)
document.getElementById('exportCsv').onclick = async () => {
  const apiKey = localStorage.getItem('API_KEY');
  const q = new URLSearchParams(window.location.search).get('q') || '';
  const url = '/policies.csv' + (q ? ('?q=' + encodeURIComponent(q)) : '');
  const res = await fetch(url, { headers: apiKey ? { 'X-API-Key': apiKey } : {} });
  if (!res.ok) { 
    let detail=''; try{ const j=await res.json(); detail=j.detail||JSON.stringify(j);}catch{}
    show('error','Export failed: ' + res.status + (detail?(' – ' + detail):'')); 
    return;
  }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'policies.csv';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
  show('ok', 'Exported policies.csv');
};

// Delete
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-del');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if(!confirm(`Delete policy #${id}?`)) return;
  const apiKey = localStorage.getItem('API_KEY');
  const res = await fetch(`/policies/${id}`, {
    method: 'DELETE',
    headers: apiKey ? { 'X-API-Key': apiKey } : {}
  });
  if(res.status === 204){ location.reload(); return; }
  let detail=''; try{ const j=await res.json(); detail=j.detail||JSON.stringify(j);}catch{}
  show('error', `Delete failed (${res.status}) ${detail}`);
});

// Header sorting (?sort=&dir=)
document.querySelectorAll('th[data-sort]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const params = new URLSearchParams(window.location.search);
    const currentSort = params.get('sort') || 'id';
    const currentDir = (params.get('dir') || 'desc').toLowerCase();
    const nextSort = th.dataset.sort;
    const nextDir = (currentSort === nextSort && currentDir === 'desc') ? 'asc' : 'desc';
    params.set('sort', nextSort);
    params.set('dir', nextDir);
    window.location.search = params.toString();
  });
});
(function markSort(){
  const p = new URLSearchParams(window.location.search);
  const s = (p.get('sort')||'id').toLowerCase();
  const d = (p.get('dir')||'desc').toLowerCase();
  const th = document.querySelector(`th[data-sort="${s}"]`);
  if(th){ th.classList.add(d === 'asc' ? 'asc' : 'desc'); }
})();
</script>
