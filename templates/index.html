<!doctype html>
<meta charset="utf-8">
<title>Policies</title>
<link rel="stylesheet" href="/static/styles.css">

<header>
  <h1 class="title">Policies</h1>
  <span id="health" class="pill">health: …</span>
  <span id="auth" class="pill">auth: off</span>
  <span class="header-actions">
    <input id="apikey" class="key-input" placeholder="X-API-Key (optional)">
    <button id="saveKey">Save key</button>
    <button id="clearKey">Clear</button>
  </span>
</header>

<div id="msg" class="banner"></div>

<form class="inline" onsubmit="event.preventDefault(); add();">
  <input id="number" placeholder="number" required minlength="3">
  <input id="holder" placeholder="holder" required minlength="2">
  <input id="premium" type="number" step="0.01" min="0" placeholder="premium" required>
  <input id="status" placeholder="status" required minlength="2">
  <button>Add</button>
</form>

<form class="inline" method="get">
  <input name="q" value="{{ q }}" placeholder="search">
  <button>Search</button>
</form>

<button id="exportCsv" style="margin-top:.5rem">Export CSV</button>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Number</th>
      <th>Holder</th>
      <th>Premium</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
  {% for p in items %}
    <tr>
      <td>{{p.id}}</td>
      <td>{{p.number}}</td>
      <td>{{p.holder}}</td>
      <td>{{"%.2f"|format(p.premium)}}</td>
      <td>{{p.status}}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script src="/static/app.js" defer>
// CSV export
document.getElementById("exportCsv").onclick = () => {
  const q = new URLSearchParams(window.location.search).get("q") || "";
  const url = "/policies.csv" + (q ? ("?q="+encodeURIComponent(q)) : "");
  window.location = url;
};
</script>
<script>
document.getElementById('exportCsv').onclick = async () => {
  const apiKey = localStorage.getItem('API_KEY');
  const q = new URLSearchParams(window.location.search).get('q') || '';
  const url = '/policies.csv' + (q ? ('?q=' + encodeURIComponent(q)) : '');
  const res = await fetch(url, { headers: apiKey ? { 'X-API-Key': apiKey } : {} });
  if (!res.ok) { 
    let detail = ''; try { const j = await res.json(); detail = j.detail || JSON.stringify(j); } catch {}
    show('error', 'Export failed: ' + res.status + (detail?(' – ' + detail):'')); 
    return; 
  }
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'policies.csv';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
  show('ok', 'Exported policies.csv');
};
</script>
<script>
// Delete with API key + confirmation
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-del');
  if(!btn) return;
  const id = btn.getAttribute('data-id');
  if(!confirm(`Delete policy #${id}?`)) return;
  const apiKey = localStorage.getItem('API_KEY');
  const res = await fetch(`/policies/${id}`, {
    method: 'DELETE',
    headers: apiKey ? { 'X-API-Key': apiKey } : {}
  });
  if(res.status === 204){ location.reload(); return; }
  let detail=''; try{ const j=await res.json(); detail=j.detail || JSON.stringify(j);}catch{}
  show('error', `Delete failed (${res.status}) ${detail}`);
});
</script>
